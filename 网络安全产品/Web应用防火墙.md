### Web应用防火墙

#### Web应用防火墙背景

应用背景，因为我们刚刚讲了防传统防火墙，下一代防火墙还有IPS，那其实呢，像防火墙跟IPS，它主要是针对于大范围的一个防护，就是你后面不管是web应用防护，有web服务，还是有数据库，还是有主机，都可以用防火墙IPS来做一个初级的防护，但是如果你后端部署的有，外部服务器，网站系统，那需要外部应用防火墙，也就是waf来提供专门的深度防护，因为网站，主要都是HTTP和HTTPS协议，而web应用防火墙呢，主要就是针对于这两个协议来进行深度防护的，你比如说针对于这两个协议的反序列化攻击，XSS攻击，SQL注入等。

所以我们需要waf来针对于网站做防护，那关于应用的话，你只要记住，只要这个客户或者是你们自己运维的，数据中心里面有网站，有外部应用，都需要waf来做专业的防护

![image-20230924193800022](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924193800022.png)

#### web应用防火墙拦截原理

那我们下面再看一下它的一个拦截原理，防护原理其实跟IPS是一样的，正常的都是通过正则表达式编写的一系列规则库，只不过waf的规则库主要是针对于HTTP做防护的，这里举了一个简单的例子，就它规则库里面预设了关键词select union from，这三个关键词，同时出现的话。一般的话都是针对于数据库的攻击，因为一般在编写的过程中，在我们访问的数据里面不会出现这三个词，但如果出现这三个词了，基本上可以判定是一个攻击行为，那就会做一个告警，一般这种都是高危告警，就直接拦截了。

图里的这个1'union select admin from users;# 就相当于从用户列表选择admin进行一个返回，查询管理员账号，那这个肯定是有风险的行为，直接拦截掉没问题。

![image-20230924194002198](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924194002198.png)

如果是正常的一段英文，刚好包含了这三个词。就会产生误拦截。就会对正常的业务访问有影响，所以这也是使用规则库的一个风险，它会有勿拦截。这也是为什么一些专业的机构在测试，在测试WAF的时候，会有两个词，会有两个数字，

两个这个测试的数字一个叫误报率，因为误报率代表你影响正常业务的可能性，

还有一个是漏报，有哪些你没有监测到它实际攻击到后端了，一般会有这两个指标，这两个指标大家了解一下，针对于正则表达式规则库的缺点，会有很高的误报率。

![image-20230924194241618](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924194241618.png)

有的厂家推出了基于语义分析的web应用防火墙，那它简单来讲就是能够从语义上真正理解当前的payload是不是攻击。所谓的理解呢，就是对目标字符串按照漏洞模型依次进行词法分析、语法分析和语义分析。然后再结合成熟的安全威胁模型打分。然后通过这个分数来判断这个是高危，中危还是低微，从而在判断进行拦截还是放行。

![image-20230924194504917](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924194504917.png)

可以看一下，中间这个payload很明显是一个sql注入的探测，判断你有没有漏洞。它是一个逻辑判断，那我们看一下，因为机器它没办法向人直接去理解这个语义，它需要去一步一步的去判断啊，如果单引号。如果单引号是闭合or的，那他们的这个词义是什么呢？

那双引号将这个二个起来之后，它就是一个字符串，然后加数字啊，再加字符串，再加一个数字，它没有逻辑的运算，所以它是没有实质含义，没有风险，但是如果这个单引号是闭合前面的，我们可以看到前面肯定是一个字符串。那中间是一个逻辑运算符。又是字符串加逻辑运算，逻辑运算符再加字符串，那它就有可能产生风险。

从而通过语义分析引擎。分析出来它是有风险的。再进行拦截这么一个原理，它有一个什么好处呢？就它不像正则表达式。

正能表达式有个什么问题啊？正常表达式，你调规则的话，如果你调的越严格，那它的误拦截率就很高，它的误拦截率就很高，但同时呢。它的漏报率就变得很低，但如果你把这个规则调的很松，它的漏报率就很高，但是误报率就很低。

它是这么一个直线下来的一个线性的，但是如果你通过语义分析呢，它就可以做到两个都很低。所以有很多对业务敏感的业务系统都采用语义分析的web应用防火墙。

![image-20230924194711246](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924194711246.png)

#### 常见的销售场景

现在我们对wa夫的基础拦截原理有了一个了解，那下面我们再看一下waf的销售场景，销售场景其实很简单，就只要有web应用，那就需要上WAF。

常见的场景呢，就是DMZ区的边界啊，也叫对外业务区啊，一般的话网站啊不会会先放在这个DMZ区，然后通过DMZ去对外地进行发布，那还有一些呢。可能会直接部署在数据中心区域，但是这一块其实我们不用纠结，我们只要抓住一个核心，只要有外部应用，就要部waf。



![image-20230924195128468](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924195128468.png)

那如何选型呢？因为我们作为售前选型，确定型号给销售，让销售去报价，其实跟防火墙差不了太多。第一个就是硬件要求，然后功能要求，因为现在waf，为什么列的跟那个防火墙差不了太多，因为现在很多厂家他都。售卖的这个WAF，很多都是UTM，就是集成的，所以我们在每家公司选型的时候都不一样。

另外一个日志存储需求也跟防火墙一样，就是六个月日志存储性能的话有一个区别，一定不要只看带宽，这样的话你可能会坑了后续的售后师傅。交付的时候发现上上去之后满足不了这个性能，因为WAF它属于应用层的设备。你不能只看网络层的性能，你还要看应用层的QPS，又或者是看它的。最大并发数以及每秒新建连接数。针对于这个去做性能选型。

另外一个呢，就是你要看它是HTTP环境下，还是HTTPS环境下，因为如果是HTTPS环境下，你的WAF是要做SSL卸载的。叫SSL卸载。因为SSL卸载对性能的消耗非常大。可能你不做SSL卸载的话，你的wa性能是1000QPS做了SSL卸载，你可能连500都达不到。

所以这两点一定要确定，第一要确定它的每秒新建连接数，或者是QPS，第二，它的场景是不是要做SSL卸载。这个一定要注意。

最后也普及一下，这个什么叫QPS啊，就是每秒查询率，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。这个大家一定要确认，因为这个是业务方知道的。

那再一个呢，就是可能我们在平常的时候会遇到客户问我这有了IPS了，也都是应用层防护，也都是应用层的防护，而且我在IPS规则里面也看到它可以防护SQ注入，为什么我还要专门买这个waf呢？



![image-20230924195336171](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924195336171.png)



那这个时候你可以这么来回复他，就是第一WAF是专门针对于HTTP协议进行安全防护的专业设备，而IPS的防护重点在于网络层协议以及少量的应用层协议。IPS防护的更全面，但是它不如waf那么专业，那如果客户再深入问的话，你就可以把下面这一段给他进行回复。

第一、就是IPS会把http会话”打碎“成多个数据包在网络层分析，当然它不是说IPS打碎的，而是说数据传过来的时候，就是由多个TCP包组成的一个完整的HTTP包，所以呢，它不能完整的从应用层角度来处理和组合多个报文，并且应用层的协议比较繁多，全部去支持也是不现实的。并且IPS的产品定位也不需要这样做，

第二点就是网站系统通常采用编码，waf有更强的解码能力，IPS对于复杂的编码是无能为力的，因为你没办法编码的话，他看到的全是乱码，你看到的不是这种正常的文字，全是那种乱码，根本就没法进行分析。

所以这两个点啊，更深层次的从技术角度来解释，为什么有了IPS还要用waf。

第一个他没有办法完整，有效的组合完整的数据包。

第二个就是编码能力太弱。![image-20230924195958191](https://jiangrou.oss-cn-beijing.aliyuncs.com/img/image-20230924195958191.png)

